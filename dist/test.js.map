{"version":3,"file":"test.js","sources":["../src/test.ts"],"sourcesContent":["import test from \"ava\";\nimport \"@k2oss/k2-broker-core/test-framework\";\nimport \"./CSVUtilities\";\n\nfunction mock(name: string, value: any) {\n  global[name] = value;\n}\n\ntest(\"describe returns the hardcoded instance\", async (t) => {\n  let schema = null;\n  mock(\"postSchema\", function (result: any) {\n    schema = result;\n  });\n\n  await Promise.resolve<void>(\n    ondescribe({\n      configuration: {},\n    })\n  );\n\n  t.deepEqual(schema, {\n    objects: {\n      todo: {\n        displayName: \"TODO\",\n        description: \"Manages a TODO list\",\n        properties: {\n          id: {\n            displayName: \"ID\",\n            type: \"number\",\n          },\n          userId: {\n            displayName: \"User ID\",\n            type: \"number\",\n          },\n          title: {\n            displayName: \"Title\",\n            type: \"string\",\n          },\n          completed: {\n            displayName: \"Completed\",\n            type: \"boolean\",\n          },\n        },\n        methods: {\n          get: {\n            displayName: \"Get TODO\",\n            type: \"read\",\n            inputs: [\"id\"],\n            outputs: [\"id\", \"userId\", \"title\", \"completed\"],\n          },\n          getParams: {\n            displayName: \"Get TODO\",\n            type: \"read\",\n            parameters: {\n              pid: {\n                displayName: \"param1\",\n                description: \"Description Of Param 1\",\n                type: \"number\",\n              },\n            },\n            requiredParameters: [\"pid\"],\n            outputs: [\"id\"],\n          },\n        },\n      },\n    },\n  });\n\n  t.pass();\n});\n\ntest(\"execute fails with the wrong parameters\", async (t) => {\n  let error = await t.throwsAsync(\n    Promise.resolve<void>(\n      onexecute({\n        objectName: \"test1\",\n        methodName: \"unused\",\n        parameters: {},\n        properties: {},\n        configuration: {},\n        schema: {},\n      })\n    )\n  );\n\n  t.deepEqual(error.message, \"The object test1 is not supported.\");\n\n  error = await t.throwsAsync(\n    Promise.resolve<void>(\n      onexecute({\n        objectName: \"todo\",\n        methodName: \"test2\",\n        parameters: {},\n        properties: {},\n        configuration: {},\n        schema: {},\n      })\n    )\n  );\n\n  t.deepEqual(error.message, \"The method test2 is not supported.\");\n\n  t.pass();\n});\n\ntest(\"execute passes with method params\", async (t) => {\n  let result: any = null;\n  function pr(r: any) {\n    result = r;\n  }\n\n  mock(\"postResult\", pr);\n\n  await Promise.resolve<void>(\n    onexecute({\n      objectName: \"todo\",\n      methodName: \"getParams\",\n      parameters: {\n        pid: 456,\n      },\n      properties: {},\n      configuration: {},\n      schema: {},\n    })\n  );\n\n  t.deepEqual(result, {\n    id: 456,\n  });\n\n  t.pass();\n});\n\ntest(\"execute passes\", async (t) => {\n  let xhr: { [key: string]: any } = null;\n  class XHR {\n    public onreadystatechange: () => void;\n    public readyState: number;\n    public status: number;\n    public responseText: string;\n    private recorder: { [key: string]: any };\n\n    constructor() {\n      xhr = this.recorder = {};\n      this.recorder.headers = {};\n    }\n\n    open(method: string, url: string) {\n      this.recorder.opened = { method, url };\n    }\n\n    setRequestHeader(key: string, value: string) {\n      this.recorder.headers[key] = value;\n    }\n\n    send() {\n      queueMicrotask(() => {\n        this.readyState = 4;\n        this.status = 200;\n        this.responseText = JSON.stringify({\n          id: 123,\n          userId: 51,\n          title: \"Groceries\",\n          completed: false,\n        });\n        this.onreadystatechange();\n        delete this.responseText;\n      });\n    }\n  }\n\n  mock(\"XMLHttpRequest\", XHR);\n\n  let result: any = null;\n  function pr(r: any) {\n    result = r;\n  }\n\n  mock(\"postResult\", pr);\n\n  await Promise.resolve<void>(\n    onexecute({\n      objectName: \"todo\",\n      methodName: \"get\",\n      parameters: {},\n      properties: {\n        id: 123,\n      },\n      configuration: {},\n      schema: {},\n    })\n  );\n\n  t.deepEqual(xhr, {\n    opened: {\n      method: \"GET\",\n      url: \"https://jsonplaceholder.typicode.com/todos/123\",\n    },\n    headers: {\n      test: \"test value\",\n    },\n  });\n\n  t.deepEqual(result, {\n    id: 123,\n    userId: 51,\n    title: \"Groceries\",\n    completed: false,\n  });\n\n  t.pass();\n});\n"],"names":["mock","name","value","global","test","t","schema","result","Promise","resolve","ondescribe","configuration","deepEqual","objects","todo","displayName","description","properties","id","type","userId","title","completed","methods","get","inputs","outputs","getParams","parameters","pid","requiredParameters","pass","throwsAsync","onexecute","objectName","methodName","error","message","pr","r","xhr","this","recorder","headers","method","url","opened","key","queueMicrotask","_this","readyState","status","responseText","JSON","stringify","onreadystatechange"],"mappings":"maAIA,SAASA,EAAKC,EAAcC,GAC1BC,OAAOF,GAAQC,EAGjBE,UAAK,uEAA2C,WAAOC,uFACjDC,EAAS,KACbN,EAAK,cAAc,SAAUO,GAC3BD,EAASC,cAGLC,QAAQC,QACZC,WAAW,CACTC,cAAe,aAInBN,EAAEO,UAAUN,EAAQ,CAClBO,QAAS,CACPC,KAAM,CACJC,YAAa,OACbC,YAAa,sBACbC,WAAY,CACVC,GAAI,CACFH,YAAa,KACbI,KAAM,UAERC,OAAQ,CACNL,YAAa,UACbI,KAAM,UAERE,MAAO,CACLN,YAAa,QACbI,KAAM,UAERG,UAAW,CACTP,YAAa,YACbI,KAAM,YAGVI,QAAS,CACPC,IAAK,CACHT,YAAa,WACbI,KAAM,OACNM,OAAQ,CAAC,MACTC,QAAS,CAAC,KAAM,SAAU,QAAS,cAErCC,UAAW,CACTZ,YAAa,WACbI,KAAM,OACNS,WAAY,CACVC,IAAK,CACHd,YAAa,SACbC,YAAa,yBACbG,KAAM,WAGVW,mBAAoB,CAAC,OACrBJ,QAAS,CAAC,YAOpBrB,EAAE0B,gGAGJ3B,UAAK,uEAA2C,WAAOC,gGACnCA,EAAE2B,YAClBxB,QAAQC,QACNwB,UAAU,CACRC,WAAY,QACZC,WAAY,SACZP,WAAY,GACZX,WAAY,GACZN,cAAe,GACfL,OAAQ,qBARV8B,SAaJ/B,EAAEO,UAAUwB,EAAMC,QAAS,+CAEbhC,EAAE2B,YACdxB,QAAQC,QACNwB,UAAU,CACRC,WAAY,OACZC,WAAY,QACZP,WAAY,GACZX,WAAY,GACZN,cAAe,GACfL,OAAQ,cARd8B,SAaA/B,EAAEO,UAAUwB,EAAMC,QAAS,sCAE3BhC,EAAE0B,gGAGJ3B,UAAK,iEAAqC,WAAOC,SAEtCiC,gFAAAA,WAAGC,GACVhC,EAASgC,GAFPhC,EAAc,KAKlBP,EAAK,aAAcsC,YAEb9B,QAAQC,QACZwB,UAAU,CACRC,WAAY,OACZC,WAAY,YACZP,WAAY,CACVC,IAAK,KAEPZ,WAAY,GACZN,cAAe,GACfL,OAAQ,aAIZD,EAAEO,UAAUL,EAAQ,CAClBW,GAAI,MAGNb,EAAE0B,gGAGJ3B,UAAK,8CAAkB,WAAOC,WAyCnBiC,gFAAAA,WAAGC,GACVhC,EAASgC,GAzCPC,EAA8B,KAqClCxC,EAAK,2DA5BDwC,EAAMC,KAAKC,SAAW,QACjBA,SAASC,QAAU,kDAGrBC,EAAgBC,QACdH,SAASI,OAAS,CAAEF,OAAAA,EAAQC,IAAAA,4CAGlBE,EAAa7C,QACvBwC,SAASC,QAAQI,GAAO7C,4CAI7B8C,gBAAe,WACbC,EAAKC,WAAa,EAClBD,EAAKE,OAAS,IACdF,EAAKG,aAAeC,KAAKC,UAAU,CACjCpC,GAAI,IACJE,OAAQ,GACRC,MAAO,YACPC,WAAW,IAEb2B,EAAKM,4BACEN,EAAKG,0BAOd7C,EAAc,KAKlBP,EAAK,aAAcsC,YAEb9B,QAAQC,QACZwB,UAAU,CACRC,WAAY,OACZC,WAAY,MACZP,WAAY,GACZX,WAAY,CACVC,GAAI,KAENP,cAAe,GACfL,OAAQ,aAIZD,EAAEO,UAAU4B,EAAK,CACfM,OAAQ,CACNF,OAAQ,MACRC,IAAK,kDAEPF,QAAS,CACPvC,KAAM,gBAIVC,EAAEO,UAAUL,EAAQ,CAClBW,GAAI,IACJE,OAAQ,GACRC,MAAO,YACPC,WAAW,IAGbjB,EAAE0B"}