!function(){var e={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var n,o,s,a,r,i,l,u="",c=0;for(t=e._utf8_encode(t);c<t.length;)a=(n=t.charCodeAt(c++))>>2,r=(3&n)<<4|(o=t.charCodeAt(c++))>>4,i=(15&o)<<2|(s=t.charCodeAt(c++))>>6,l=63&s,isNaN(o)?i=l=64:isNaN(s)&&(l=64),u=u+this._keyStr.charAt(a)+this._keyStr.charAt(r)+this._keyStr.charAt(i)+this._keyStr.charAt(l);return u},decode:function(t){var n,o,s,a,r,i,l="",u=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<t.length;)n=this._keyStr.indexOf(t.charAt(u++))<<2|(a=this._keyStr.indexOf(t.charAt(u++)))>>4,o=(15&a)<<4|(r=this._keyStr.indexOf(t.charAt(u++)))>>2,s=(3&r)<<6|(i=this._keyStr.indexOf(t.charAt(u++))),l+=String.fromCharCode(n),64!=r&&(l+=String.fromCharCode(o)),64!=i&&(l+=String.fromCharCode(s));return l=e._utf8_decode(l)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var o=e.charCodeAt(n);o<128?t+=String.fromCharCode(o):o>127&&o<2048?(t+=String.fromCharCode(o>>6|192),t+=String.fromCharCode(63&o|128)):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128),t+=String.fromCharCode(63&o|128))}return t},_utf8_decode:function(e){for(var t="",n=0,o=0,s=0,a=0;n<e.length;)(o=e.charCodeAt(n))<128?(t+=String.fromCharCode(o),n++):o>191&&o<224?(s=e.charCodeAt(n+1),t+=String.fromCharCode((31&o)<<6|63&s),n+=2):(s=e.charCodeAt(n+1),a=e.charCodeAt(n+2),t+=String.fromCharCode((15&o)<<12|(63&s)<<6|63&a),n+=3);return t}};const t="id",n="Name",o="Value",s="SFName",a="SFValue",r="SFCombinedString",i="column1",l="column2",u="column3",c="column4",d="column5",m="column6",p="column7",y="column8",C="column9",g="column10",S="column11",N="column12",h="column13",f="column14",v="column15",w="column16",b="column17",x="column18",R="column19",k="column20",A="column21",F="column22",V="column23",U="column24",_="column25",I="column26",J="column27",T="column28",j="column29",H="column30",O="column31",P="column32",D="column33",L="column34",q="column35",E="column36",B="column37",z="column38",M="column39",X="column40",$="column41",K="column42",Z="column43",G="column44",W="column45",Q="column46",Y="column47",ee="column48",te="column49",ne="column50",oe="column51",se="column52",ae="column53",re="column54",ie="column55",le="column56",ue="column57",ce="column58",de="column59",me="column60",pe="column61",ye=61;var Ce={displayName:"Read CSV as JSON",description:"CSV to JSON Object",properties:{csv:{displayName:"CSV File",type:"extendedString"},[t]:{displayName:"ID",description:"ID",type:"number"},[n]:{displayName:"Name",description:"Name",type:"extendedString"},[o]:{displayName:"Value",description:"Value",type:"extendedString"},[s]:{displayName:"SFName",description:"Name",type:"extendedString"},[a]:{displayName:"SFValue",description:"Value",type:"extendedString"},SFParentID:{displayName:"SFParentID",description:"ParentID",type:"extendedString"},[r]:{displayName:"SFCombinedString",description:"CombinedString",type:"extendedString"},[i]:{displayName:"Column 1",description:"Column 1",type:"string"},[l]:{displayName:"Column 2",description:"Column 2",type:"string"},[u]:{displayName:"Column 3",description:"Column 3",type:"string"},[c]:{displayName:"Column 4",description:"Column 4",type:"string"},[d]:{displayName:"Column 5",description:"Column 5",type:"string"},[m]:{displayName:"Column 6",description:"Column 6",type:"string"},[p]:{displayName:"Column 7",description:"Column 7",type:"string"},[y]:{displayName:"Column 8",description:"Column 8",type:"string"},[C]:{displayName:"Column 9",description:"Column 9",type:"string"},[g]:{displayName:"Column 10",description:"Column 10",type:"string"},[S]:{displayName:"Column 11",description:"Column 11",type:"string"},[N]:{displayName:"Column 12",description:"Column 12",type:"string"},[h]:{displayName:"Column 13",description:"Column 13",type:"string"},[f]:{displayName:"Column 14",description:"Column 14",type:"string"},[v]:{displayName:"Column 15",description:"Column 15",type:"string"},[w]:{displayName:"Column 16",description:"Column 16",type:"string"},[b]:{displayName:"Column 17",description:"Column 17",type:"string"},[x]:{displayName:"Column 18",description:"Column 18",type:"string"},[R]:{displayName:"Column 19",description:"Column 19",type:"string"},[k]:{displayName:"Column 20",description:"Column 20",type:"string"},[A]:{displayName:"Column 21",description:"Column 21",type:"string"},[F]:{displayName:"Column 22",description:"Column 22",type:"string"},[V]:{displayName:"Column 23",description:"Column 23",type:"string"},[U]:{displayName:"Column 24",description:"Column 24",type:"string"},[_]:{displayName:"Column 25",description:"Column 25",type:"string"},[I]:{displayName:"Column 26",description:"Column 26",type:"string"},[J]:{displayName:"Column 27",description:"Column 27",type:"string"},[T]:{displayName:"Column 28",description:"Column 28",type:"string"},[j]:{displayName:"Column 29",description:"Column 29",type:"string"},[H]:{displayName:"Column 30",description:"Column 30",type:"string"},[O]:{displayName:"Column 31",description:"Column 31",type:"string"},[P]:{displayName:"Column 32",description:"Column 32",type:"string"},[D]:{displayName:"Column 33",description:"Column 33",type:"string"},[L]:{displayName:"Column 34",description:"Column 34",type:"string"},[q]:{displayName:"Column 35",description:"Column 35",type:"string"},[E]:{displayName:"Column 36",description:"Column 36",type:"string"},[B]:{displayName:"Column 37",description:"Column 37",type:"string"},[z]:{displayName:"Column 38",description:"Column 38",type:"string"},[M]:{displayName:"Column 39",description:"Column 39",type:"string"},[X]:{displayName:"Column 40",description:"Column 40",type:"string"},[$]:{displayName:"Column 41",description:"Column 41",type:"string"},[K]:{displayName:"Column 42",description:"Column 42",type:"string"},[Z]:{displayName:"Column 43",description:"Column 43",type:"string"},[G]:{displayName:"Column 44",description:"Column 44",type:"string"},[W]:{displayName:"Column 45",description:"Column 45",type:"string"},[Q]:{displayName:"Column 46",description:"Column 46",type:"string"},[Y]:{displayName:"Column 47",description:"Column 47",type:"string"},[ee]:{displayName:"Column 48",description:"Column 48",type:"string"},[te]:{displayName:"Column 49",description:"Column 49",type:"string"},[ne]:{displayName:"Column 50",description:"Column 50",type:"string"},[oe]:{displayName:"Column 51",description:"Column 51",type:"string"},[se]:{displayName:"Column 52",description:"Column 52",type:"string"},[ae]:{displayName:"Column 53",description:"Column 53",type:"string"},[re]:{displayName:"Column 54",description:"Column 54",type:"string"},[ie]:{displayName:"Column 55",description:"Column 55",type:"string"},[le]:{displayName:"Column 56",description:"Column 56",type:"string"},[ue]:{displayName:"Column 57",description:"Column 57",type:"string"},[ce]:{displayName:"Column 58",description:"Column 58",type:"string"},[de]:{displayName:"Column 59",description:"Column 59",type:"string"},[me]:{displayName:"Column 60",description:"Column 60",type:"string"},[pe]:{displayName:"Column 61",description:"Column 61",type:"string"},ColumnName:{displayName:"Column Index",description:"Column Index",type:"string"},output:{displayName:"Output",type:"extendedString"}},methods:{readCSV:{displayName:"Read CSV",type:"list",inputs:["csv"],outputs:[t,i,l,u,c,d,m,p,y,C,g,S,N,h,f,v,w,b,x,R,k,A,F,V,U,_,I,J,T,j,H,O,P,D,L,q,E,B,z,M,X,$,K,Z,G,W,Q,Y,ee,te,ne,oe,se,ae,re,ie,le,ue,ce,de,me,pe]},readCsvRow:{displayName:"Get a Row from CSV File",type:"read",inputs:["csv","id"],outputs:["id","column1","column2","column3","column4","column5","column6","column7","column8","column9","column10","column11","column12","column13","column14","column15","column16","column17","column18","column19","column20","column21","column22","column23","column24","column25","column26","column27","column28","column29","column30","column31","column32","column33","column34","column35","column36","column37","column38","column39","column40","column41","column42","column43","column44","column45","column46","column47","column48","column49","column50","column51","column52","column53","column54","column55","column56","column57","column58","column59","column60","column61"]},listHeaders:{displayName:"List Headers from CSV",type:"list",inputs:["csv","id"],outputs:[t,n,o]},readRowHeaders:{displayName:"Read Header row from CSV",type:"read",inputs:["csv","id"],outputs:[t,n,o]},combineString:{displayName:"Combine Strings for BULK API Upload",type:"read",inputs:["SFParentID","SFValue","SFName"],outputs:[r]}}};async function ge(t,n,o,s){switch(t){case"readCSV":await function(t,n){return new Promise((n,o)=>{try{var s=e.decode(Se(t.csv.toString())).split("\n"),a=new RegExp('"',"g"),r=0,i=s.map(e=>{let t={};r+=1;var n=e.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);t.id=r;for(var o=0;o<n.length;o++)o+1<61&&(t["column"+(o+1)]=n[o].replace(a,""));return t});postResult(i),n()}catch(e){o(e)}})}(n);break;case"readCsvRow":await function(t,n,o){return new Promise((t,o)=>{try{const o=e.decode(Se(n.csv.toString()));var s=new RegExp('"',"g"),a=+n.id,r=o.split(/\r?\n/)[a-1];let u={};var i=r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);u.id=a;for(var l=0;l<i.length;l++)l+1<61&&(u["column"+(l+1)]=i[l].replace(s,""));postResult(u),t()}catch(e){o(e)}})}(0,n);break;case"listHeaders":await function(t,n,o){return new Promise((t,o)=>{try{const o=e.decode(Se(n.csv.toString()));var s=new RegExp('"',"g"),a=[],r=+n.id,i=(a=o.split(/\r?\n/))[0],l=a[r-1];let d={};var u=l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);d=i.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(e=>{let t={};return t.Name=e,t});for(var c=0;c<u.length;c++)c+1<ye&&(d[c].id=c+1,d[c].Value=u[c].replace(s,""));postResult(d),t()}catch(e){o(e)}})}(0,n);break;case"combineString":await function(e,t,n){return new Promise((e,n)=>{console.log("executed");for(var o="",s=t.SFName.toString(),a=t.SFValue.toString(),r=s.split(","),i=a.split(","),l=0;l<r.length;l++)o+=t.SFParentID+","+r[l]+","+i[l]+"\n";postResult({SFCombinedString:o}),e()})}(0,n);break;default:throw new Error("The method "+t+" is not supported.")}}function Se(e){return e.split("<content>")[1].split("</content>")[0]}var Ne={displayName:"Salesforce Job Functions",description:"Salesforce Job Functions",properties:{jobId:{displayName:"Job Id",type:"string"},resultCode:{displayName:"Result Code",type:"string"},message:{displayName:"Message",type:"extendedString"},csvFile:{displayName:"CSV File",type:"attachment"},csvFileContent:{displayName:"File Content",type:"extendedString"},oldHeader:{displayName:"Old Header",type:"extendedString"},newHeader:{displayName:"New Header",type:"extendedString"},sobrId:{displayName:"SOBRID",type:"string"},csvString:{displayName:"CSV string",type:"extendedString"}},methods:{createJob:{displayName:"Create a New Job",type:"execute",parameters:{instanceUrl:{displayName:"Instance URL",type:"extendedString"},version:{displayName:"Version",type:"string"},token:{displayName:"Token",type:"string"},sfobject:{displayName:"SF Object",type:"string"},le:{displayName:"Line Ending",type:"string"}},inputs:[],outputs:["jobId","resultCode","message"]},updateJobState:{displayName:"Update Job State",type:"execute",parameters:{instanceUrl:{displayName:"Instance URL",type:"extendedString"},version:{displayName:"Version",type:"string"},token:{displayName:"Token",type:"string"}},inputs:["jobId"],outputs:["resultCode","message"]},uploadJobData:{displayName:"Upload Job Data",type:"execute",parameters:{instanceUrl:{displayName:"Instance URL",type:"extendedString"},version:{displayName:"Version",type:"string"},token:{displayName:"Token",type:"string"}},inputs:["jobId","csvFile"],outputs:["resultCode","message"]},convertAndUploadJobData:{displayName:"Convert and Upload Job Data",type:"execute",parameters:{instanceUrl:{displayName:"Instance URL",type:"extendedString"},version:{displayName:"Version",type:"string"},token:{displayName:"Token",type:"string"}},inputs:["jobId","oldHeader","newHeader","sobrId","csvFileContent"],outputs:["resultCode","message"]},createCSVAndUploadJobData:{displayName:"Create CSV and Upload Job Data",type:"execute",parameters:{instanceUrl:{displayName:"Instance URL",type:"extendedString"},version:{displayName:"Version",type:"string"},token:{displayName:"Token",type:"string"}},inputs:["jobId","csvString"],outputs:["resultCode","message"]}}};async function he(e,t,n,o){switch(e){case"updateJobState":await function(e,t,n){return new Promise((n,o)=>{try{var s=JSON.stringify({state:"UploadComplete"}),a=new XMLHttpRequest;return a.withCredentials=!0,a.onreadystatechange=function(){if(4===a.readyState){if(200!==a.status)throw new Error("Failed with status ".concat(a.status.toString()," ").concat(a.statusText," and response ").concat(JSON.stringify(a.response)," "));postResult({resultCode:a.status,message:a.statusText})}},a.open("PATCH",e.instanceUrl+"/services/data/"+e.version+"/jobs/ingest/"+t.jobId),a.setRequestHeader("Authorization","Bearer "+e.token),a.setRequestHeader("Content-Type","application/json"),a.send(s)}catch(e){o(e)}})}(n,t);break;case"uploadJobData":await function(e,t,n){return new Promise((n,o)=>{try{var s=new XMLHttpRequest;return s.withCredentials=!0,s.onreadystatechange=function(){if(4===s.readyState){if(201!==s.status)throw new Error("Failed with status ".concat(s.status.toString()," ").concat(s.statusText," and response ").concat(JSON.stringify(s.response)," "));postResult({resultCode:s.status,message:s.statusText})}},s.open("PUT",e.instanceUrl+"/services/data/"+e.version+"/jobs/ingest/"+t.jobId+"/batches"),s.setRequestHeader("Authorization","Bearer "+e.token),s.setRequestHeader("Content-Type","text/csv"),s.send(t.csvFile)}catch(e){o(e)}})}(n,t);break;case"convertAndUploadJobData":await function(e,t,n){return new Promise((n,o)=>{try{const n=fe.decode((u=t.csvFileContent.toString(),u.split("<content>")[1].split("</content>")[0]));var s=t.oldHeader.toString(),a=t.newHeader.toString(),r=t.sobrId.toString(),i=n.replace(s,"");i=a+(i=i.replace(new RegExp("\n","g"),"\n"+r+","));var l=new XMLHttpRequest;return l.withCredentials=!0,l.onreadystatechange=function(){if(4===l.readyState){if(201!==l.status)throw new Error("Failed with status ".concat(l.status.toString()," ").concat(l.statusText," and response ").concat(JSON.stringify(l.response)," "));postResult({resultCode:l.status,message:l.statusText})}},l.open("PUT",e.instanceUrl+"/services/data/"+e.version+"/jobs/ingest/"+t.jobId+"/batches"),l.setRequestHeader("Authorization","Bearer "+e.token),l.setRequestHeader("Content-Type","text/csv"),l.send(i)}catch(e){o(e)}var u})}(n,t);break;case"createJob":await function(e,t,n){return new Promise((t,n)=>{try{console.log(e.sfobject);var o=JSON.stringify({object:e.sfobject,contentType:"CSV",operation:"insert",lineEnding:e.le}),s=new XMLHttpRequest;return s.withCredentials=!0,s.onreadystatechange=function(){if(4!==s.readyState)return;if(200!==s.status)throw new Error("Failed with status ".concat(s.status.toString()," ").concat(s.statusText," and response ").concat(JSON.stringify(s.response)," "));let e=JSON.parse(s.responseText);postResult({jobId:e.id,resultCode:s.status,message:s.statusText})},s.open("POST",e.instanceUrl+"/services/data/"+e.version+"/jobs/ingest"),s.setRequestHeader("Authorization","Bearer "+e.token),s.setRequestHeader("Content-Type","application/json"),s.send(o)}catch(e){n(e)}})}(n);break;case"createCSVAndUploadJobData":await function(e,t,n){return new Promise((n,o)=>{try{var s=new XMLHttpRequest,a=t.csvString.toString();return a=a.replace(new RegExp(/\$LB\//gm),"\n"),s.withCredentials=!0,s.onreadystatechange=function(){if(4===s.readyState){if(201!==s.status)throw new Error("Failed with status ".concat(s.status.toString()," ").concat(s.statusText," and response ").concat(JSON.stringify(s.response)," "));postResult({resultCode:s.status,message:s.statusText})}},s.open("PUT",e.instanceUrl+"/services/data/"+e.version+"/jobs/ingest/"+t.jobId+"/batches"),s.setRequestHeader("Authorization","Bearer "+e.token),s.setRequestHeader("Content-Type","text/csv"),console.log("Posted CSV: "+a),s.send(a)}catch(e){o(e)}})}(n,t);break;default:throw new Error("The method "+e+" is not supported.")}}var fe={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,n,o,s,a,r,i,l="",u=0;for(e=fe._utf8_encode(e);u<e.length;)s=(t=e.charCodeAt(u++))>>2,a=(3&t)<<4|(n=e.charCodeAt(u++))>>4,r=(15&n)<<2|(o=e.charCodeAt(u++))>>6,i=63&o,isNaN(n)?r=i=64:isNaN(o)&&(i=64),l=l+this._keyStr.charAt(s)+this._keyStr.charAt(a)+this._keyStr.charAt(r)+this._keyStr.charAt(i);return l},decode:function(e){var t,n,o,s,a,r,i="",l=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<e.length;)t=this._keyStr.indexOf(e.charAt(l++))<<2|(s=this._keyStr.indexOf(e.charAt(l++)))>>4,n=(15&s)<<4|(a=this._keyStr.indexOf(e.charAt(l++)))>>2,o=(3&a)<<6|(r=this._keyStr.indexOf(e.charAt(l++))),i+=String.fromCharCode(t),64!=a&&(i+=String.fromCharCode(n)),64!=r&&(i+=String.fromCharCode(o));return i=fe._utf8_decode(i)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var o=e.charCodeAt(n);o<128?t+=String.fromCharCode(o):o>127&&o<2048?(t+=String.fromCharCode(o>>6|192),t+=String.fromCharCode(63&o|128)):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128),t+=String.fromCharCode(63&o|128))}return t},_utf8_decode:function(e){for(var t="",n=0,o=0,s=0,a=0;n<e.length;)(o=e.charCodeAt(n))<128?(t+=String.fromCharCode(o),n++):o>191&&o<224?(s=e.charCodeAt(n+1),t+=String.fromCharCode((31&o)<<6|63&s),n+=2):(s=e.charCodeAt(n+1),a=e.charCodeAt(n+2),t+=String.fromCharCode((15&o)<<12|(63&s)<<6|63&a),n+=3);return t}};metadata={systemName:"ReadCSVasJSON",displayName:"Read CSV as JSON",description:"A Utility broker using CSV in K2 Workflows",configuration:{ServiceURL:{displayName:"Service URL",type:"string",value:"https://www.cloudfunctions.net"}}},ondescribe=async function({configuration:e}){postSchema({objects:{csvFunctions:Ce,jobFunctions:Ne}})},onexecute=async function({objectName:e,methodName:t,parameters:n,properties:o,configuration:s}){switch(e){case"csvFunctions":await ge(t,o);break;case"jobFunctions":await he(t,o,n);break;default:throw new Error("The object "+e+" is not supported.")}}}();
//# sourceMappingURL=CSVUtilities.jssp.map
